<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Job - EMR Job Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 12H4.5a2.5 2.5 0 0 1 0-5H9"></path>
                    <path d="M15 12h4.5a2.5 2.5 0 0 0 0-5H15"></path>
                    <line x1="9" y1="12" x2="15" y2="12"></line>
                    <line x1="9" y1="17" x2="15" y2="17"></line>
                    <line x1="12" y1="12" x2="12" y2="17"></line>
                </svg>
                EMR Job Manager
            </div>
            <ul class="sidebar-menu">
                <li class="sidebar-menu-item" id="dashboard-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </li>
                <li class="sidebar-menu-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline>
                        <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path>
                    </svg>
                    Submit Job
                </li>
            </ul>
            <div class="sidebar-footer">
                Job Manager v1.0.0
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Header -->
                <div class="main-header">
                    <div>
                        <div class="breadcrumb">
                            <a href="{{ url_for('index') }}">Dashboard</a>
                            <span class="breadcrumb-separator">/</span>
                            <span>Submit Job</span>
                        </div>
                        <h1 class="page-title">Submit New Job</h1>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                {% if category == 'success' %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                {% endif %}
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Job Submission Form -->
                <div class="card mb-lg">
                    <div class="card-header">
                        <h2 class="card-title">Job Details</h2>
                        <span class="text-muted">Complete the form to submit a new job</span>
                    </div>
                    <div class="card-body">
                        <form id="job-submission-form" method="post" action="{{ url_for('submit_job') }}">
                            <div class="form-grid">
                                <div class="form-column">
                                    <div class="form-group">
                                        <label for="cluster-select" class="form-label">Select EMR Cluster</label>
                                        <select id="cluster-select" name="cluster_id" class="form-select" required>
                                            <option value="">-- Select Cluster --</option>
                                            {% for cluster in clusters %}
                                            <option value="{{ cluster.Id }}" 
                                                    {% if preselected_cluster_id and preselected_cluster_id == cluster.Id %}selected{% endif %}>
                                                {{ cluster.Name }} ({{ cluster.Id }}) - {{ cluster.Status.State }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <small class="text-muted">Choose the EMR cluster where the job will run</small>
                                    </div>
                                    <div id="cluster-alert" class="alert alert-info">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="16" x2="12" y2="12"></line>
                                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                        </svg>
                                        <div>
                                            <strong id="cluster-name">No cluster selected</strong><br>
                                            <span id="cluster-status">Please select a cluster to see its details</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-column">
                                    <div class="form-group">
                                        <label for="job-type-select" class="form-label">Job Type</label>
                                        <select id="job-type-select" name="job_type" class="form-select" required>
                                            <option value="">-- Select Job Type --</option>
                                            {% for job_type in job_types %}
                                            <option value="{{ job_type }}">
                                                {{ job_type | replace('_', ' ') | title }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <small class="text-muted">Select the type of job to run</small>
                                    </div>

                                    <div id="job-type-description" class="mb-md">
                                        <div class="alert alert-info">
                                            <div id="job-description-content">Please select a job type to see its description</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Options Toggle -->
                            <div class="form-group">
                                <div class="d-flex align-center gap-sm">
                                    <input type="checkbox" id="show-advanced-options">
                                    <label for="show-advanced-options" class="mb-0">Show advanced options</label>
                                </div>
                            </div>

                            <!-- Advanced Options (hidden by default) -->
                            <div id="advanced-options" style="display: none;">
                                <h3 class="mb-sm">Job Parameters</h3>
                                <div class="form-group">
                                    <label for="param-batch-size" class="form-label">Batch Size</label>
                                    <input type="number" id="param-batch-size" name="batch_size" class="form-control" value="1000">
                                    <small class="text-muted">Number of records to process in each batch</small>
                                </div>
                                <div class="form-group">
                                    <label for="param-checkpoint-location" class="form-label">Checkpoint Location</label>
                                    <input type="text" id="param-checkpoint-location" name="checkpoint_location" class="form-control" placeholder="s3://bucket/path/to/checkpoint">
                                    <small class="text-muted">S3 location to store checkpoints (optional)</small>
                                </div>

                                <h3 class="mb-sm mt-md">Execution Configuration</h3>
                                <div class="form-group">
                                    <label for="param-executor-cores" class="form-label">Executor Cores</label>
                                    <input type="number" id="param-executor-cores" name="executor_cores" class="form-control" value="1">
                                    <small class="text-muted">Number of cores per executor</small>
                                </div>
                                <div class="form-group">
                                    <label for="param-executor-memory" class="form-label">Executor Memory (GB)</label>
                                    <input type="number" id="param-executor-memory" name="executor_memory" class="form-control" value="2">
                                    <small class="text-muted">Memory allocated to each executor</small>
                                </div>
                                <div class="form-group">
                                    <label for="param-num-executors" class="form-label">Number of Executors</label>
                                    <input type="number" id="param-num-executors" name="num_executors" class="form-control" value="3">
                                    <small class="text-muted">Total number of executors to use</small>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="form-group d-flex justify-between align-center">
                                <button type="button" id="cancel-btn" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="23 3 12 14 9 11"></polyline>
                                    </svg>
                                    Submit Job
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Currently Running Jobs Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Currently Running Jobs</h2>
                        <span class="badge badge-warning" id="total-running-jobs-count">0</span>
                    </div>
                    <div class="card-body">
                        <div id="running-jobs-container">
                            <div class="table-scrollable">
                                <table class="data-table running-jobs-table">
                                    <thead>
                                        <tr>
                                            <th>Step ID</th>
                                            <th>Job Name</th>
                                            <th>Cluster ID</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="running-jobs-list">
                                        <tr class="no-jobs-row">
                                            <td colspan="4" class="text-center text-muted">
                                                No running jobs
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() { 
            // Dashboard and cancel navigation
            const dashboardNav = document.getElementById('dashboard-nav');
            const cancelBtn = document.getElementById('cancel-btn');
            
            if (dashboardNav) {
            dashboardNav.addEventListener('click', function() {
                window.location.href = "{{ url_for('index') }}";
            });
            }

            if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('index') | safe }}";
            });
            }

            // Job type descriptions
            const jobDescriptions = {
            'ui_sevs': 'Process security events data and store them in Elasticsearch for UI consumption. This job reads data from Kafka, validates against schema, and writes to Elasticsearch index.',
            'ui_event_logs': 'Process event logs data and store them in Elasticsearch for UI consumption. The job reads from Kafka logs topic and indexes data for quick retrieval.',
            'ui_sevs_aggs': 'Aggregate security events data for visualization in the UI dashboards. This creates pre-computed aggregations to improve query performance.',
            'ui_event_logs_aggs': 'Aggregate event logs data for visualization in dashboards. Creates optimized aggregated views based on various dimensions.',
            'ice_sevs': 'Process security events data and store them in Iceberg tables. This job reads from Kafka and writes to Apache Iceberg tables in S3.',
            'can_ml_batch': 'Run machine learning predictions on CAN messages in batch mode. Uses LSTM model to detect anomalies in CAN bus messages.'
            };

            // Form elements
            const clusterSelect = document.getElementById('cluster-select');
            const jobTypeSelect = document.getElementById('job-type-select');
            const clusterNameEl = document.getElementById('cluster-name');
            const clusterStatusEl = document.getElementById('cluster-status');
            const jobDescriptionContent = document.getElementById('job-description-content');
            const showAdvancedOptionsCheckbox = document.getElementById('show-advanced-options');
            const advancedOptions = document.getElementById('advanced-options');
            const runningJobsList = document.getElementById('running-jobs-list');
            const totalRunningJobsCount = document.getElementById('total-running-jobs-count');

            // Cluster selection handler
            clusterSelect.addEventListener('change', function() {
            const selectedClusterId = this.value;
            
            if (selectedClusterId) {
                const clusterData = JSON.parse('{{ clusters|tojson|safe }}');
                const selectedCluster = clusters.find(cluster => cluster.Id === selectedClusterId);
                
                if (selectedCluster) {
                clusterNameEl.textContent = `${selectedCluster.Name} (${selectedCluster.Id})`;
                
                let statusClass = '';
                if (selectedCluster.Status.State === 'RUNNING') {
                    statusClass = 'text-success';
                } else if (selectedCluster.Status.State === 'WAITING') {
                    statusClass = 'text-info';
                } else {
                    statusClass = 'text-warning';
                }
                
                clusterStatusEl.innerHTML = `<span class="${statusClass}">${selectedCluster.Status.State}</span>`;
                }
            } else {
                clusterNameEl.textContent = "No cluster selected";
                clusterStatusEl.textContent = "Please select a cluster to see its details";
            }
            });
            
            // Job type selection handler
            jobTypeSelect.addEventListener('change', function() {
            const selectedJobType = this.value;
            
            if (selectedJobType) {
                const description = jobDescriptions[selectedJobType] || 'No description available for this job type.';
                jobDescriptionContent.innerHTML = description;
            } else {
                jobDescriptionContent.innerHTML = "Please select a job type to see its description";
            }
            });

            // Advanced options toggle
            showAdvancedOptionsCheckbox.addEventListener('change', function() {
            advancedOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Form validation
            document.getElementById('job-submission-form').addEventListener('submit', function(event) {
            const clusterId = clusterSelect.value;
            const jobType = jobTypeSelect.value;
            
            if (!clusterId) {
                event.preventDefault();
                alert('Please select a cluster.');
                clusterSelect.focus();
                return false;
            }
            
            if (!jobType) {
                event.preventDefault();
                alert('Please select a job type.');
                jobTypeSelect.focus();
                return false;
            }
            
            if (!confirm(`Are you sure you want to submit the ${jobType.replace('_', ' ')} job to cluster ${clusterId}?`)) {
                event.preventDefault();
                return false;
            }
            
            return true;
            });

            // Preselect cluster and job type from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedClusterId = urlParams.get('cluster_id');
            const preselectedJobType = urlParams.get('job_type');

            if (preselectedClusterId) {
            clusterSelect.value = preselectedClusterId;
            clusterSelect.dispatchEvent(new Event('change'));
            }

            if (preselectedJobType) {
            jobTypeSelect.value = preselectedJobType;
            jobTypeSelect.dispatchEvent(new Event('change'));
            }

            // Check if a cluster is pre-selected when the page loads
            if (clusterSelect && clusterSelect.value) {
            // Get the selected option's text
            const selectedOption = clusterSelect.options[clusterSelect.selectedIndex];
            const clusterName = selectedOption.text;
            const clusterAlert = document.getElementById('cluster-alert');
            
            // Update the alert message
            document.getElementById('cluster-name').textContent = clusterName;
            document.getElementById('cluster-status').innerHTML = `<span class="text-success">Selected</span>`;
            }

            // Fetch and display running jobs
            function fetchRunningJobs() {
            fetch('/api/running_jobs')
                .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
                })
                .then(jobsData => {
                // Clear existing rows except header
                const noJobsRow = runningJobsList.querySelector('.no-jobs-row');
                if (noJobsRow) {
                    runningJobsList.removeChild(noJobsRow);
                }
                runningJobsList.innerHTML = ''; // Clear existing jobs

                // Update jobs count
                totalRunningJobsCount.textContent = jobsData.length;

                // Populate jobs
                if (jobsData.length === 0) {
                    const noJobsRow = document.createElement('tr');
                    noJobsRow.classList.add('no-jobs-row');
                    noJobsRow.innerHTML = `
                    <td colspan="4" class="text-center text-muted">
                        No running jobs
                    </td>
                    `;
                    runningJobsList.appendChild(noJobsRow);
                } else {
                    jobsData.forEach(job => {
                    const jobRow = document.createElement('tr');
                    jobRow.innerHTML = `
                        <td>${job.step_id}</td>
                        <td>${job.job_name}</td>
                        <td>${job.cluster_id}</td>
                        <td>
                        <form action="{{ url_for('stop_job') }}" method="post" class="stop-job-form">
                            <input type="hidden" name="step_id" value="${job.step_id}">
                            <input type="hidden" name="cluster_id" value="${job.cluster_id}">
                            <button type="submit" class="btn btn-danger btn-sm stop-job-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            </svg>
                            Stop
                            </button>
                        </form>
                        </td>
                    `;
                    runningJobsList.appendChild(jobRow);
                    });
                }

                // Setup stop job confirmations
                setupStopJobConfirmation();
                })
                .catch(error => {
                console.error('Error fetching running jobs:', error);
                totalRunningJobsCount.textContent = '0';
                runningJobsList.innerHTML = `
                    <tr class="no-jobs-row">
                    <td colspan="4" class="text-center text-danger">
                        Error loading jobs: ${error.message}
                    </td>
                    </tr>
                `;
                });
            }

            function setupStopJobConfirmation() {
            document.querySelectorAll('.stop-job-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                const stepId = this.querySelector('input[name="step_id"]').value;
                const clusterId = this.querySelector('input[name="cluster_id"]').value;
                
                if (!confirm(`Are you sure you want to stop the job with Step ID ${stepId} on cluster ${clusterId}?\n\nWarning: This will terminate the running job.`)) {
                    e.preventDefault();
                }
                });
            });
            }

            // Initial fetch and setup periodic refresh
            fetchRunningJobs();
            setInterval(fetchRunningJobs, 30000); // Refresh every 30 seconds
        });
    </script>

    <style>
        .table-scrollable {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .running-jobs-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .running-jobs-table thead {
            position: sticky;
            top: 0;
            background-color: var(--background-light);
            z-index: 10;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }

        .running-jobs-table th, 
        .running-jobs-table td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }

        .running-jobs-table .stop-job-btn {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .running-jobs-table .stop-job-btn svg {
            margin-right: 4px;
        }

        .no-jobs-row td {
            padding: var(--space-lg);
            text-align: center;
        }
    </style>
</body>
</html>
